name: R-CMD-check

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  R-CMD-check:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    
    - name: Set up R
      uses: r-lib/actions/setup-r@v2
      with:
        version: 'latest'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libcurl4-openssl-dev libxml2-dev libssl-dev
    
    - name: Set GitHub PAT
      env:
        GITHUB_PAT: ${{ secrets.GH_PAT }}
    
    - name: Install R dependencies from CRAN
      run: |
        Rscript -e "install.packages('remotes')"
        Rscript -e "remotes::install_deps(dependencies = TRUE)"
    
    - name: Install GitHub packages
      run: |
        Rscript -e "remotes::install_github('omnideconv/immunedeconv', auth_token = Sys.getenv('GITHUB_PAT'))"
        Rscript -e "remotes::install_github('dviraran/xCell', auth_token = Sys.getenv('GITHUB_PAT'))"
        Rscript -e "remotes::install_github('GfellerLab/EPIC', auth_token = Sys.getenv('GITHUB_PAT'))"
        Rscript -e "remotes::install_github('IOBR/IOBR', auth_token = Sys.getenv('GITHUB_PAT'))"
        Rscript -e "remotes::install_github('kevinblighe/EnhancedVolcano', auth_token = Sys.getenv('GITHUB_PAT'))"
    
    - name: Build vignettes
      run: |
        Rscript -e "devtools::build_vignettes()"

    - name: Check
      run: R CMD check --as-cran .
